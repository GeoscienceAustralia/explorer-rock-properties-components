var rpComponents;!function(t){var e;!function(e){"use strict";var r=function(){function t(t,e,r){this.$scope=t,this.clusterChartService=e,this.clusterService=r}return t.$inject=["$scope","clusterChartService","clusterService"],t}();e.ClusterChartCtrl=r;var n=function(){function t(t,e){this.$http=t,this.$rootScope=e}return t.prototype.hideChart=function(){this.$rootScope.$broadcast("chart.update",{targetChartId:!1})},t.prototype.buildChart=function(t){document.getElementById("cluster-summary-chart-d3").innerHTML="",this.$rootScope.$broadcast("chart.update",{targetChartId:"clusterSummaryChart"}),d3.json("resources/mock-service/explorer-cossap-services/service/rock-properties/clusters/cluster.json",function(t,e){var r,n,i,o,s=1250,a=255,c=e.length<7?e.length:4;.35*document.body.clientHeight>a&&document.body.clientWidth>s?(i={top:0,right:10,bottom:0,left:10},r=document.body.clientWidth/c-(2*i.left+i.right),n=.35*document.body.clientHeight,o=20):(i={top:0,right:5,bottom:0,left:5},r=s/c-(2*i.left+i.right),n=a,o=15);var l=document.body.clientWidth-(2*i.left+i.right),u=Math.min(r,n)/2;e.forEach(function(t){function e(e,i,o,l){var h=p.selectAll("g.legendg").data(e).enter().append("g").attr("class","legendg").attr("transform",function(t,e){return"translate("+-(r/2.3)+","+(e*(S+x)-n/4)+")"}),d=h.append("rect").attr("x",45).attr("width",S).attr("height",S).attr("class","legend").style("fill",function(t,e){return c(t.attributeName)}),m=h.append("text").attr("x",65).attr("y",6).attr("dy",".35em").style("text-anchor","start").text(function(t){var e=(u-20)/5;return t.attributeName.length>e?t.attributeName.substring(0,e)+"...":t.attributeName});if(d.append("svg:title").text(function(e){var r=d3.sum(t.data.map(function(t){return t.count}));return e.attributeName+" ("+Math.round(1e3*e.count/r)/10+"%)"}),m.append("svg:title").text(function(e){var r=d3.sum(t.data.map(function(t){return t.count}));return e.attributeName+" ("+Math.round(1e3*e.count/r)/10+"%)"}),l>1){var v=p.append("g").attr("class","pageNo").attr("transform","translate(-10,"+((i+1)*(S+x)-n/4)+")");v.append("text").text(o+"/"+l).attr("dx",".25em");var C=p.append("g").attr("class","prev").attr("transform","translate(-20,"+((i+1.5)*(S+x)-n/4)+")").on("click",s).style("cursor","pointer"),g=p.append("g").attr("class","next").attr("transform","translate(0,"+((i+1.5)*(S+x)-n/4)+")").on("click",a).style("cursor","pointer");g.append("polygon").style("stroke","#000").style("fill","#000").attr("points","0,0, 20,0, 10,10"),C.append("polygon").style("stroke","#000").style("fill","#000").attr("points","0,10, 20,10, 10,0"),o==l?(g.style("opacity","0.3"),g.on("click","").style("cursor","")):1==o&&(C.style("opacity","0.3"),C.on("click","").style("cursor",""))}}function s(){f--,p.selectAll("g.legendg").remove(),p.select(".pageNo").remove(),p.select(".prev").remove(),p.select(".next").remove();for(var r=(f-1)*C,n=r+C,i=[],o=0;o<t.data.length;o++)o>=r&&n>o&&i.push(t.data[o]);e(i,C,f,g)}function a(){f++,p.selectAll("g.legendg").remove(),p.select(".pageNo").remove(),p.select(".prev").remove(),p.select(".next").remove();for(var r=(f-1)*C,n=r+C,i=[],o=0;o<t.data.length;o++)o>=r&&n>o&&i.push(t.data[o]);e(i,C,f,g)}var c=d3.scale.category20(),p=d3.select("#cluster-summary-chart-d3").append("svg").attr("width",r).attr("height",n).style("margin-left",i.left+"px").style("margin-right",i.right+"px").append("g").attr("transform","translate("+r/2+","+(n/2+10)+")"),h=d3.svg.arc().innerRadius(u-o).outerRadius(u),d=d3.layout.pie().value(function(t){return t.count}).sort(null),m=d3.select("#cluster-summary-chart-d3").append("div").attr("class","cluster-summary-tooltip");m.append("div").attr("class","attribute"),m.append("div").attr("class","count"),m.append("div").attr("class","percent");var v=p.selectAll("path").data(d(t.data)).enter().append("path").attr("d",h).attr("fill",function(t,e){return c(t.data.attributeName)}).each(function(t){this._current=t});v.on("mouseover",function(e){var r=d3.sum(t.data.map(function(t){return t.count})),n=Math.round(1e3*e.data.count/r)/10;m.select(".attribute").html(e.data.attributeName),m.select(".count").html("Count: "+e.data.count),m.select(".percent").html("Percent: "+n+"%"),m.style("display","block")}),v.on("mouseout",function(){m.style("display","none")}),v.on("mousemove",function(t){var e=d3.event.pageX>l-180?d3.event.pageX-180:d3.event.pageX,r=d3.event.pageY>document.body.clientHeight-120?d3.event.pageY-100:d3.event.pageY+10;m.style("top",r+"px").style("left",e+"px")}),p.append("g").attr("class","cluster-summary-chart-title").append("text").attr("x",0).attr("y",-(n/2+7)).attr("dy",".71em").style("text-anchor","middle").style("fill","#000").style("font-weight","bold").text(t.propertyName);var C,g,f,y=t.data.length,S=15,x=6,w=(S+x)*y;if(w/u>1){C=Math.floor(u/(S+x)),g=Math.ceil(y/C),f=1;for(var b=(f-1)*C,I=b+C,E=[],A=0;A<t.data.length;A++)A>=b&&I>A&&E.push(t.data[A]);e(E,C,f,g)}else e(t.data,Math.floor(u/(S+x)),1,1)})}),document.getElementById("cluster-summary-chart-d3").style.display="none",setTimeout(function(){document.getElementById("cluster-summary-chart-loading").style.display="none",document.getElementById("cluster-summary-chart-d3").style.display="block"},1500)},t.$inject=["$http","$rootScope"],t}();e.ClusterChartService=n,angular.module("explorer.rockproperties.charts",[]).factory("clusterChartService",["$http","$rootScope",function(e,r){return new t.chartService.ClusterChartService(e,r)}]).controller("clusterChartCtrl",r).directive("clusterChartSummary",function(){return{templateUrl:"rockprops/cluster-summary.html",controller:r,controllerAs:"clusterChartVM"}})}(e=t.chartService||(t.chartService={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(t){var e;!function(t){"use strict";var e=function(){function t(t,e,r,n,i,o,s,a,c){this.count=t,this.lat=e,this.lon=r,this.elev=n,this.lithologyGroup=i,this.property=o,this.provinceName=s,this.sampleType=a,this.stratigraphicUnitName=c}return t.$inject=["count","lat","lon","elev","lithologyGroup","property","provinceName","sampleType","stratigraphicUnitName"],t}();t.Cluster=e}(e=t.cluster||(t.cluster={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(t){var e;!function(e){"use strict";var r=function(){function t(t,e,r,n,i){var o=this;this.$http=t,this.$rootScope=e,this.zoomLevelService=r,this.clusterChartService=n,this.chartSpinnerService=i,this.reCluster=function(){var t=[],e=new Cesium.LabelCollection;o.getClusters().then(function(r){if(r.data){for(var n=r.data,i=0;i<n.length;i++)t.push(o.buildSphereInstance(n[i])),e.add(o.buildLabel(n[i]));o.drawClusters(t,e)}else console.log("got no clusters")})}}return t.prototype.init=function(t,e,r){var n=this;this.viewer=t,this.zoomLevelService.viewer=t,this.serviceUrl=e,this.$rootScope.$on("rocks.clusters.update",function(){n.reCluster()}),r&&(this.pickHandler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),this.pickHandlerAction=function(t){var e=n.viewer.scene.pick(t.position);Cesium.defined(e)&&e.hasOwnProperty("id")&&e.id.hasOwnProperty("lat")&&(n.clearHighlighted(),n.targetId=e.id,n.queryCluster(n.targetId),n.setHighlighted(n.targetId,!0))},this.pickHandler.setInputAction(this.pickHandlerAction,Cesium.ScreenSpaceEventType.LEFT_CLICK))},t.prototype.setHighlighted=function(t,e){var r=this.clusterPrimitive.getGeometryInstanceAttributes(t);r&&e&&(r.prevColor=r.color,r.color=Cesium.ColorGeometryInstanceAttribute.toValue(Cesium.Color.fromCssColorString("#F5ED05").withAlpha(1)))},t.prototype.clearHighlighted=function(){if(this.targetId){var t=this.clusterPrimitive.getGeometryInstanceAttributes(this.targetId);t&&t.hasOwnProperty("prevColor")&&(t.color=t.prevColor)}},t.prototype.toggleClusters=function(){this.clustersCollection?(this.clustersCollection.show=!this.clustersCollection.show,this.zoomLevelService.setActive(this.clustersCollection.show),this.clustersCollection.show?this.pickHandler.setInputAction(this.pickHandlerAction,Cesium.ScreenSpaceEventType.LEFT_CLICK):this.pickHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK),this.reCluster()):(this.clustersCollection=new Cesium.PrimitiveCollection,this.viewer.scene.primitives.add(this.clustersCollection),this.zoomLevelService.setActive(!0),this.reCluster())},t.prototype.getClusters=function(){return this.$http({method:"GET",url:this.serviceUrl+this.zoomLevelService.nextIndex+".json",headers:{"Content-Type":"application/json"},data:{heightIndex:this.zoomLevelService.nextIndex,extent:this.zoomLevelService.getViewExtent(100)}})},t.prototype.queryCluster=function(t){var e=this;this.summarySpinner?document.getElementById("cluster-summary-chart-loading").style.display="block":(this.summarySpinner=this.chartSpinnerService.addSpinner({width:100,height:100,container:"#cluster-summary-chart-loading",id:"chart-spinner"}),this.summarySpinner()),this.$http({method:"GET",url:this.serviceUrl+"cluster-summary.json",headers:{"Content-Type":"application/json"},data:{targetCluster:t}}).then(function(t){t.hasOwnProperty("data")&&e.clusterChartService.buildChart(t.data)})},t.prototype.drawClusters=function(t,e){this.clustersCollection.removeAll(),this.clusterPrimitive=new Cesium.Primitive({geometryInstances:t,appearance:new Cesium.PerInstanceColorAppearance({translucent:!0,closed:!0})}),this.clustersCollection.add(this.clusterPrimitive),this.clustersCollection.add(e)},t.prototype.buildSphereInstance=function(t){var e=this.computeClusterAttributes(t.count),r=Cesium.Cartesian3.fromDegrees(t.lon,t.lat),n=Cesium.Matrix4.multiplyByTranslation(Cesium.Transforms.eastNorthUpToFixedFrame(r),new Cesium.Cartesian3(t.lon,t.lat,e.size),new Cesium.Matrix4),i=new Cesium.SphereGeometry({vertexFormat:Cesium.PerInstanceColorAppearance.VERTEX_FORMAT,radius:e.size}),o=new Cesium.GeometryInstance({geometry:i,modelMatrix:n,vertexFormat:Cesium.EllipsoidSurfaceAppearance.VERTEX_FORMAT,attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(e.color)},id:t});return o},t.prototype.buildLabel=function(t){var e=this.computeClusterAttributes(t.count);return{position:Cesium.Cartesian3.fromDegrees(t.lon,t.lat,20+2*e.size),text:t.count.toString(),fillColor:Cesium.Color.BLACK,outlineColor:Cesium.Color.RED,font:"30px arial, sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.CENTER}},t.prototype.computeClusterAttributes=function(t){return 10>t?{size:1e4*this.zoomLevelService.nextIndex,color:Cesium.Color.fromCssColorString("#4781cd").withAlpha(.5)}:t>=10&&1e3>t?{size:1e4*this.zoomLevelService.nextIndex,color:Cesium.Color.fromCssColorString("#0fc70e").withAlpha(.5)}:{size:1e4*this.zoomLevelService.nextIndex,color:Cesium.Color.fromCssColorString("#ff0000").withAlpha(.5)}},t.$inject=["$http","$rootScope","zoomLevelService","clusterChartService","chartSpinnerService"],t}();e.ClusterService=r,angular.module("explorer.rockproperties.clusters",[]).factory("clusterService",["$http","$rootScope","zoomLevelService","clusterChartService","chartSpinnerService",function(e,r,n,i,o){return new t.clusterService.ClusterService(e,r,n,i,o)}])}(e=t.clusterService||(t.clusterService={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(t){var e;!function(e){"use strict";var r=function(){function t(){}return t.prototype.addSpinner=function(t){return function(){function e(t,r){t.transition().ease("linear").duration(r).attrTween("transform",function(){return d3.interpolateString("rotate(0)","rotate(360)")}),setTimeout(function(){e(t,r)},r)}var r=Math.min(t.width,t.height)/2,n=2*Math.PI,i=d3.svg.arc().innerRadius(.5*r).outerRadius(.9*r).startAngle(0),o=d3.select(t.container).append("svg").attr("id",t.id).attr("width",t.width).attr("height",t.height).append("g").attr("transform","translate("+t.width/2+","+t.height/2+")");o.append("path").datum({endAngle:.33*n}).style("fill","#4D4D4D").attr("d",i).call(e,1500)}},t}();e.ChartSpinnerService=r,angular.module("explorer.rockproperties.spinner",[]).factory("chartSpinnerService",[function(){return new t.spinnerService.ChartSpinnerService}])}(e=t.spinnerService||(t.spinnerService={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(t){var e;!function(e){"use strict";var r=function(){function t(t){var e=this;this.$rootScope=t,this.zoomLevels=[5e3,1e4,2e4,4e4,75e4,15e5,25e5,35e5,55e5,65e5,8e6],this.defaultExtent={west:109,south:-45,east:158,north:-8},this.moveEndHandler=function(){e.nextIndex=e.getIndex(Cesium.Ellipsoid.WGS84.cartesianToCartographic(e.viewer.camera.position).height),e.previousIndex>-1&&e.previousIndex!=e.nextIndex&&e.$rootScope.$broadcast("rocks.clusters.update",e.nextIndex),e.previousIndex=e.nextIndex}}return t.prototype.getIndex=function(t){for(var e=0;e<this.zoomLevels.length;e++)if(t<this.zoomLevels[e])return e;return this.zoomLevels.length-1},t.prototype.setActive=function(t){t?(this.previousIndex=this.getIndex(Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.viewer.camera.position).height),this.nextIndex=this.previousIndex,this.viewer.camera.moveEnd.addEventListener(this.moveEndHandler)):this.viewer.camera.moveEnd.removeEventListener(this.moveEndHandler)},t.prototype.getViewExtent=function(t){var e=Cesium.Ellipsoid.WGS84,r=window.devicePixelRatio||1,n=new Cesium.Cartesian2(-t,-t),i=this.viewer.scene.camera.pickEllipsoid(n,e);n=new Cesium.Cartesian2(this.viewer.scene.canvas.width/r+t,this.viewer.scene.canvas.height/r+t);var o=this.viewer.scene.camera.pickEllipsoid(n,e);return null!=i&&null!=o?(i=e.cartesianToCartographic(i),o=e.cartesianToCartographic(o),i.longitude>o.longitude?this.defaultExtent:{west:Cesium.Math.toDegrees(i.longitude),south:Cesium.Math.toDegrees(o.latitude),east:Cesium.Math.toDegrees(o.longitude),north:Cesium.Math.toDegrees(i.latitude)}):this.defaultExtent},t.$inject=["$rootScope"],t}();e.ZoomLevelService=r,angular.module("explorer.rockproperties.zoom",[]).factory("zoomLevelService",["$rootScope",function(e){return new t.zoom.ZoomLevelService(e)}])}(e=t.zoom||(t.zoom={}))}(rpComponents||(rpComponents={})),angular.module("explorer.rockproperties.templates",[]).run(["$templateCache",function(t){t.put("rockprops/cluster-summary.html",'<div id="clusterSummaryChart" ng-show="cossapChartState.targetChartId == \'clusterSummaryChart\'">\n\n	<div class="btn-group" style="position: absolute;right: 10px;top: 10px;">\n		<button type="button" class="btn btn-default" title="Close graphs" ng-click="clusterChartVM.clusterChartService.hideChart(); clusterChartVM.clusterService.clearHighlighted();">\n			<i class="fa fa-times-circle" role="presentation" style="font-size:16px; color:black"></i>\n		</button>\n	</div>\n\n\n	<div id="cluster-summary-chart-d3"></div>\n\n	<div id="cluster-summary-chart-loading"></div>\n\n</div>')}]);
//# sourceMappingURL=explorer-rock-properties-components.min.js.map
