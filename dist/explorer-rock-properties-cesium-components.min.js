var rpComponents;!function(e){var t;!function(t){"use strict";var r=function(){function e(e){this.$rootScope=e}return e.prototype.setConfig=function(e,t){this.config=e,this.viewer=t,this.$rootScope.$broadcast("rocks.config.ready")},e.$inject=["$rootScope"],e}();t.RocksConfigService=r,angular.module("explorer.rockproperties.config",[]).factory("rocksConfigService",["$rootScope",function(t){return new e.config.RocksConfigService(t)}])}(t=e.config||(e.config={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(e){var t;!function(t){"use strict";var r=function(){function e(e,t){var r=this;this.$rootScope=e,this.rocksConfigService=t,this.zoomLevels=[5e3,1e4,2e4,3e4,5e4,8e4,2e5,1e6,15e5,2e6,4e6,65e5,85e5,1e7,15e6,1e8],this.defaultExtent={west:109,south:-45,east:158,north:-8},this.moveEndHandler=function(){r.nextPosition=Cesium.Ellipsoid.WGS84.cartesianToCartographic(r.viewer.camera.position),(r.previousPosition.height>-1&&r.getIndex(r.previousPosition.height)!=r.nextIndex||Math.abs(r.nextPosition.latitude-r.previousPosition.latitude)>.01/r.nextIndex||Math.abs(r.nextPosition.longitude-r.previousPosition.longitude)>.01/r.nextIndex||16==r.nextIndex)&&r.$rootScope.$broadcast("rocks.clusters.update",r.nextIndex),console.log("INDEX = "+r.nextIndex+" HEIGHT = "+Cesium.Ellipsoid.WGS84.cartesianToCartographic(r.viewer.camera.position).height),r.previousPosition=r.nextPosition},this.$rootScope.$on("rocks.config.ready",function(){r.viewer=r.rocksConfigService.viewer})}return Object.defineProperty(e.prototype,"nextIndex",{get:function(){return this.getIndex(this.nextPosition.height)},enumerable:!0,configurable:!0}),e.prototype.getIndex=function(e){for(var t=0;t<this.zoomLevels.length;t++)if(e<this.zoomLevels[t])return this.zoomLevels.length-t;return this.zoomLevels.length-1},e.prototype.setActive=function(e){e?(this.nextPosition=this.previousPosition=Cesium.Ellipsoid.WGS84.cartesianToCartographic(this.viewer.camera.position),this.viewer.camera.moveEnd.addEventListener(this.moveEndHandler)):this.viewer.camera.moveEnd.removeEventListener(this.moveEndHandler)},e.prototype.getViewExtent=function(e){var t=Cesium.Ellipsoid.WGS84,r=window.devicePixelRatio||1,i=new Cesium.Cartesian2(-e,-e),o=this.viewer.scene.camera.pickEllipsoid(i,t);i=new Cesium.Cartesian2(this.viewer.scene.canvas.width/r+e,this.viewer.scene.canvas.height/r+e);var s=this.viewer.scene.camera.pickEllipsoid(i,t);return null!=o&&null!=s?(o=t.cartesianToCartographic(o),s=t.cartesianToCartographic(s),o.longitude>s.longitude?this.defaultExtent:{west:Cesium.Math.toDegrees(o.longitude),south:Cesium.Math.toDegrees(s.latitude),east:Cesium.Math.toDegrees(s.longitude),north:Cesium.Math.toDegrees(o.latitude)}):this.defaultExtent},e.$inject=["$rootScope","rocksConfigService"],e}();t.ZoomLevelService=r,angular.module("explorer.rockproperties.zoom",[]).factory("zoomLevelService",["$rootScope","rocksConfigService",function(t,r){return new e.zoom.ZoomLevelService(t,r)}])}(t=e.zoom||(e.zoom={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(e){var t;!function(t){"use strict";var r=function(){function e(){}return e.prototype.calculateWeighting=function(e){return Math.pow(1.43,e)},e}();t.ClusterHeightWeighter=r;var i=function(){function e(e,t,i,o,s,n,c,l){var a=this;this.$http=e,this.$rootScope=t,this.zoomLevelService=i,this.clusterChartService=o,this.loadingSpinnerService=s,this.rocksConfigService=n,this.clusterInspectorService=c,this.clusterFilterState=l,this.clusterRangeMeta={maxExtrudeHeight:6e6},this.clusterFilter="",this.reCluster=function(){var e=[],t=new Cesium.LabelCollection;a.getClusters().then(function(i){if(i.data&&i.data.features){var o=i.data.features,s=(new r).calculateWeighting(a.zoomLevelService.nextIndex);a.clusterRangeMeta.maxCount=d3.max(o,function(e){return e.properties.count}),a.clusterRangeMeta.scale=d3.scale.linear().domain([0,a.clusterRangeMeta.maxCount]).range([0,a.clusterRangeMeta.maxExtrudeHeight/s]);for(var n=0;n<o.length;n++){o[n].properties.featureType="rockPropsCluster";var c=a.computeClusterAttributes(o[n].properties.count);e.push(a.buildClusterInstance(o[n],c)),t.add(a.buildLabel(o[n],c))}a.drawClusters(e,t)}else console.log("got no clusters"),console.log(i)})},this.$rootScope.$on("rocks.config.ready",function(){a.viewer=a.rocksConfigService.viewer,a.serviceUrl=a.rocksConfigService.config.rocksServiceUrl}),this.$rootScope.$on("rocks.clusters.update",function(){a.reCluster()})}return e.prototype.toggleClusters=function(){return this.clustersCollection?(this.clustersCollection.show=!this.clustersCollection.show,this.zoomLevelService.setActive(this.clustersCollection.show),this.clustersCollection.show?this.clusterInspectorService.setPickEnabled(!0):this.clusterInspectorService.setPickEnabled(!1),this.reCluster()):(this.clustersCollection=new Cesium.PrimitiveCollection,this.viewer.scene.primitives.add(this.clustersCollection),this.zoomLevelService.setActive(!0),this.reCluster(),this.clusterInspectorService.setPickEnabled(!0)),this.clustersCollection.show},e.prototype.getClusters=function(){function e(e,t){return t>e?t:e}function t(e,t){return e>t?t:e}var r=this.zoomLevelService.getViewExtent(100).west,i=this.zoomLevelService.getViewExtent(100).east,o=this.zoomLevelService.getViewExtent(100).north,s=this.zoomLevelService.getViewExtent(100).south,n=.2*(i-r),c=.2*(o-s),l="?zoom="+this.zoomLevelService.nextIndex+"&xmin="+e(r-n,-180)+"&xmax="+t(i+n,180)+"&ymin="+e(s-c,-90)+"&ymax="+t(o+c,90)+this.clusterFilterState.filterQuery;return console.log("summary query: "+this.serviceUrl+l),this.$http({method:"GET",url:this.serviceUrl+"summary"+l})},e.prototype.drawClusters=function(e,t){this.clustersCollection.removeAll(),this.clusterPrimitive=new Cesium.Primitive({geometryInstances:e,appearance:new Cesium.PerInstanceColorAppearance({translucent:!0,closed:!0})}),this.clusterInspectorService.setClusterPrimitive(this.clusterPrimitive),this.clustersCollection.add(this.clusterPrimitive),this.clustersCollection.add(t)},e.prototype.buildClusterInstance=function(e,t){return new Cesium.GeometryInstance({geometry:new Cesium.CircleGeometry({center:Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[0],e.geometry.coordinates[1]),radius:t.radius,vertexFormat:Cesium.PerInstanceColorAppearance.VERTEX_FORMAT,extrudedHeight:t.extrudeHeight}),id:e,attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(t.color)}})},e.prototype.buildLabel=function(e,t){return{position:Cesium.Cartesian3.fromDegrees(e.geometry.coordinates[0],e.geometry.coordinates[1],t.extrudeHeight+t.radius+30),text:e.properties.count.toString(),fillColor:Cesium.Color.BLACK,outlineColor:Cesium.Color.RED,font:26-.2*this.zoomLevelService.nextIndex+"px arial, sans-serif",horizontalOrigin:Cesium.HorizontalOrigin.CENTER,id:e}},e.prototype.computeClusterAttributes=function(e){var t=this.zoomLevelService.zoomLevels[this.zoomLevelService.zoomLevels.length-this.zoomLevelService.nextIndex]/150,r=.6*this.zoomLevelService.nextPosition.height,i=this.clusterRangeMeta.scale(e)/Math.pow(this.zoomLevelService.nextIndex/3,1.15);i>r&&(i=r),t>r/20&&(console.log("To big!"),t=r/20);var o={radius:t,extrudeHeight:i};return 100>e?o.color=Cesium.Color.fromCssColorString("#4781cd").withAlpha(.5):1e3>e?(o.radius*=1.3,o.color=Cesium.Color.fromCssColorString("#0fc70e").withAlpha(.5)):(o.radius*=1.6,o.color=Cesium.Color.fromCssColorString("#ff0000").withAlpha(.5)),o},e.$inject=["$http","$rootScope","zoomLevelService","clusterChartService","loadingSpinnerService","rocksConfigService","clusterInspectorService","clusterFilterState"],e}();t.ClusterService=i,angular.module("explorer.rockproperties.clusters",[]).factory("clusterService",["$http","$rootScope","zoomLevelService","clusterChartService","loadingSpinnerService","rocksConfigService","clusterInspectorService","clusterFilterState",function(t,r,i,o,s,n,c,l){return new e.clusterService.ClusterService(t,r,i,o,s,n,c,l)}])}(t=e.clusterService||(e.clusterService={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(e){var t;!function(t){"use strict";var r=function(){function e(e,t,r){var i=this;this.$scope=e,this.rocksPanelService=t,this.wmsInspectorService=r,this.targetPanel="",this.$scope.$on("rocks.accordion.update",function(e,t){i.targetPanel=t})}return e.prototype.setTargetPanel=function(e){this.targetPanel=this.targetPanel!=e?e:""},e.$inject=["$scope","rocksPanelService","wmsInspectorService"],e}();t.RocksPanelCtrl=r;var i=function(){function e(e,t,r,i){this.$rootScope=e,this.clusterService=t,this.wmsPointsService=r,this.rocksConfigService=i,this.clustersEnabled=!1,this.pointsEnabled=!1}return e.prototype.init=function(e,t){this.viewer=e,this.rocksConfigService.setConfig(t,e)},e.prototype.toggleClusters=function(){this.clustersEnabled=this.clusterService.toggleClusters()},e.prototype.togglePoints=function(){this.pointsEnabled=this.wmsPointsService.togglePoints()},e.$inject=["$rootScope","clusterService","wmsPointsService","rocksConfigService"],e}();t.RocksPanelService=i,angular.module("explorer.rockproperties.controlpanel",[]).factory("rocksPanelService",["$rootScope","clusterService","wmsPointsService","rocksConfigService",function(t,r,i,o){return new e.controlPanel.RocksPanelService(t,r,i,o)}]).controller("rocksPanelCtrl",r).directive("rocksControlPanel",function(){return{templateUrl:"rockprops/control-panel.html",controller:r,controllerAs:"controlPanelVM"}})}(t=e.controlPanel||(e.controlPanel={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(e){var t;!function(t){"use strict";var r=function(){function e(e,t,r){this.$scope=e,this.clusterInspectorService=t,this.rocksPanelService=r}return e.$inject=["$scope","clusterInspectorService","rocksPanelService"],e}();t.ClusterInspectorCtrl=r;var i=function(){function e(e,t){this.count=e,this.total=t}return e.prototype.more=function(){return this.total>this.count},e}();t.PagingState=i;var o=function(){function e(e,t,r,i,o,s,n,c){var l=this;this.$http=e,this.$rootScope=t,this.$timeout=r,this.zoomLevelService=i,this.loadingSpinnerService=o,this.rocksConfigService=s,this.clusterChartService=n,this.clusterFilterState=c,this.inspectMode="CHART",this.listReady=!1,this.maxListStep=100,this.$rootScope.$on("rocks.config.ready",function(){l.init()})}return e.prototype.init=function(){var e=this;this.viewer=this.rocksConfigService.viewer,this.serviceUrl=this.rocksConfigService.config.rocksServiceUrl,this.rocksConfigService.config.useClusterPicking&&(this.pickHandler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),this.pickHandlerAction=function(t){var r=e.viewer.scene.pick(t.position);Cesium.defined(r)&&Cesium.defined(r.id)&&r.id.hasOwnProperty("properties")&&"rockPropsCluster"==r.id.properties.featureType&&(e.listReady=!1,e.clearHighlighted(),e.targetId=r.id,e.setHighlighted(e.targetId,!0),e.targetPos=Cesium.Ellipsoid.WGS84.cartesianToCartographic(e.viewer.camera.pickEllipsoid(t.position)),"CHART"==e.inspectMode?e.chartClusterQuery():(e.listIndex=0,e.listClusterQuery()))})},e.prototype.chartClusterQuery=function(){var e=this;this.summarySpinner?document.getElementById("cluster-summary-chart-loading").style.display="block":(this.summarySpinner=this.loadingSpinnerService.addSpinner({width:100,height:100,container:"#cluster-summary-chart-loading",id:"chart-spinner"}),this.summarySpinner());var t="?zoom="+this.zoomLevelService.nextIndex+"&x="+Cesium.Math.toDegrees(this.targetPos.longitude)+"&y="+Cesium.Math.toDegrees(this.targetPos.latitude)+this.clusterFilterState.filterQuery,r=this.serviceUrl+"query"+t;console.log("query"),console.log(r),this.$http({method:"GET",url:r}).then(function(t){t.hasOwnProperty("data")&&e.clusterChartService.buildChart(t.data)}),ga("send","event","explorer-rock-properties","click","cluster inspector summary charts")},e.prototype.loadNextListStep=function(){this.listIndex+=this.maxListStep,console.log("loadNextListStep "+this.listIndex),this.listClusterQuery()},e.prototype.listClusterQuery=function(){var e=this;console.log("listClusterQuery"),this.listSpinner?document.getElementById("cluster-result-list-loading").style.display="block":(this.listSpinner=this.loadingSpinnerService.addSpinner({width:100,height:100,container:"#cluster-result-list-loading",id:"cluster-result-list-spinner"}),this.listSpinner());var t="?zoom="+this.zoomLevelService.nextIndex+"&maxCount="+this.maxListStep+"&startIndex="+this.listIndex+"&x="+Cesium.Math.toDegrees(this.targetPos.longitude)+"&y="+Cesium.Math.toDegrees(this.targetPos.latitude)+this.clusterFilterState.filterQuery,r=this.serviceUrl+"features"+t;console.log("features query"),console.log(r),this.$http({method:"GET",url:r}).then(function(t){t.hasOwnProperty("data")&&e.$timeout(function(){document.getElementById("cluster-result-list-loading").style.display="none",e.listReady=!0,0!=e.listIndex?e.listFeatures.features=e.listFeatures.features.concat(t.data.features):e.listFeatures=t.data;e.listFeatures.features.length<e.listFeatures.totalFeatures;e.pagingState=new i(e.listFeatures.features.length,e.listFeatures.totalFeatures)},1e3)}),ga("send","event","explorer-rock-properties","click","cluster inspector feature list (startIndex: "+this.listIndex+")")},e.prototype.setPickEnabled=function(e){e?this.pickHandler.setInputAction(this.pickHandlerAction,Cesium.ScreenSpaceEventType.LEFT_CLICK):this.pickHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK)},e.prototype.setClusterPrimitive=function(e){this.clusterPrimitive=e},e.prototype.setHighlighted=function(e,t){var r=this.clusterPrimitive.getGeometryInstanceAttributes(e);r&&t&&(r.prevColor=r.color,r.color=Cesium.ColorGeometryInstanceAttribute.toValue(Cesium.Color.fromCssColorString("#ff00ff").withAlpha(1)))},e.prototype.clearHighlighted=function(){if(this.targetId){var e=this.clusterPrimitive.getGeometryInstanceAttributes(this.targetId);e&&e.hasOwnProperty("prevColor")&&(e.color=e.prevColor)}},e.$inject=["$http","$rootScope","$timeout","zoomLevelService","loadingSpinnerService","rocksConfigService","clusterChartService","clusterFilterState"],e}();t.ClusterInspectorService=o,angular.module("explorer.rockproperties.clusterinspector",[]).controller("clusterInspectorCtrl",r).directive("rocksClusterInspectorPanel",function(){return{templateUrl:"rockprops/cluster-inspector.html",controller:r,controllerAs:"clusterInspectorVM"}}).factory("clusterInspectorService",["$http","$rootScope","$timeout","zoomLevelService","loadingSpinnerService","rocksConfigService","clusterChartService","clusterFilterState",function(t,r,i,o,s,n,c,l){return new e.clusterInspector.ClusterInspectorService(t,r,i,o,s,n,c,l)}])}(t=e.clusterInspector||(e.clusterInspector={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(e){var t;!function(t){"use strict";var r=function(){function e(){this.view="INTRO"}return e}();t.WmsInspectorState=r,angular.module("explorer.rockproperties.inspectorstate",[]).factory("wmsInspectorState",[function(){return new e.wmsInspectorState.WmsInspectorState}])}(t=e.wmsInspectorState||(e.wmsInspectorState={}))}(rpComponents||(rpComponents={}));var rpComponents;!function(e){var t;!function(t){"use strict";var r=function(){function e(e,t,r){this.$scope=e,this.wmsInspectorState=t,this.wmsInspectorService=r}return e.$inject=["$scope","wmsInspectorState","wmsInspectorService"],e}();t.WmsInspectorCtrl=r;var i=function(){function e(e,t,r,i,o,s,n,c,l){var a=this;this.$rootScope=e,this.$http=t,this.wmsInspectorState=r,this.assetsService=i,this.configService=o,this.rocksConfigService=s,this.loadingSpinnerService=n,this.gwsUtilService=c,this.rocksClipShipService=l,this.isLoading=!1,this.URL_EXCLUDE="?SERVICE=WMS&",this.SURFACE_GEO="GA_Surface_Geology_of_Australia",this.$inject=["$rootScope","$http","wmsInspectorState","assetsService","configService","rocksConfigService","loadingSpinnerService","gwsUtilService","rocksClipShipService"],this.$rootScope.$on("viewer.click.left",function(e,t){t.degrees={lat:Cesium.Math.toDegrees(t.cartographic.latitude),lon:Cesium.Math.toDegrees(t.cartographic.longitude)},a.rocksClipShipService.isDrawing||a.inspectorEnabled&&t.hasOwnProperty("cartographic")&&(a.$rootScope.$broadcast("rocks.accordion.update","wmsInspector"),a.$rootScope.$broadcast("toolbar.toggle.update",{linked:!1,key:"rocksClusters",isActive:!0}),a.wmsInspectorState.targetGeom=t,a.wmsInspectorState.view="LAYERSELECT",a.wmsInspectorState.cameraHeight=Cesium.Ellipsoid.WGS84.cartesianToCartographic(a.rocksConfigService.viewer.camera.position).height)}),this.$rootScope.$on("rocks.config.ready",function(){i.getReferenceFeatureClasses().then(function(e){a.features=e}),a.rocksFeature={wmsUrl:a.rocksConfigService.config.geoserverWmsUrl,name:"Rock Properties Layer"}})}return e.prototype.togglePointInspector=function(){this.inspectorEnabled!=this.inspectorEnabled},e.prototype.queryRocks=function(){if(!this.rocksFeature.hasOwnProperty("layers")&&this.gwsUtilService.wmsLayerNames){this.rocksFeature.layers=[];for(var e=0;e<this.gwsUtilService.wmsLayerNames.length;e++)this.rocksFeature.layers.push(this.rocksConfigService.config.geoserverWmsLayerPrefix+this.gwsUtilService.wmsLayerNames[e])}this.queryFeature(this.rocksFeature)},e.prototype.queryFeature=function(e){var t=this;ga("send","event","explorer-rock-properties","click","wms inspector query: "+e.name),this.wmsInspectorState.view="FEATUREINFO",this.toggleLoading();var r=e.wmsUrl,i=e.layers;r.indexOf(this.URL_EXCLUDE)>-1&&(r=r.substring(0,r.length-this.URL_EXCLUDE.length)),r.indexOf(this.SURFACE_GEO)>-1&&(i=this.wmsInspectorState.cameraHeight<=34e4?[i[0]]:[i[1]]);var o="?SERVICE=WMS&REQUEST=GetFeatureInfo&VERSION=1.1.1&LAYERS="+i+"&STYLES=&SRS=EPSG%3A4326&FORMAT=image%2Fpng&BBOX="+this.wmsInspectorState.targetGeom.degrees.lon+","+this.wmsInspectorState.targetGeom.degrees.lat+","+(this.wmsInspectorState.targetGeom.degrees.lon+.003)+","+(this.wmsInspectorState.targetGeom.degrees.lat+.003)+"&QUERY_LAYERS="+i+"&INFO_FORMAT=text%2Fhtml&FEATURE_COUNT=100&WIDTH=2&HEIGHT=2&X=1&Y=1&TRANSPARENT=true&EXCEPTIONS=application%2Fvnd.ogc.se_xml";this.$http.get(r+o).success(function(e){t.featureInfo=e,t.toggleLoading()}).error(function(e,t,r,i){console.log("Couldn't load WMS GetFeatureInfo"),this.featureInfo="<h5>Couldn't load WMS GetFeatureInfo for this layer.</h5><p>You may not be able to access this function for some layers.</p>",this.toggleLoading()})},e.prototype.toggleLoading=function(){this.loadingSpinner?this.isLoading=!this.isLoading:(this.loadingSpinner=this.loadingSpinnerService.addSpinner({width:60,height:60,container:"#rocks-inspector-loading",id:"rocks-inspector-spinner"}),this.loadingSpinner(),this.isLoading=!0)},e}();t.WmsInspectorService=i,angular.module("explorer.rockproperties.inspector",[]).factory("wmsInspectorService",["$rootScope","$http","wmsInspectorState","assetsService","configService","rocksConfigService","loadingSpinnerService","gwsUtilService","rocksClipShipService",function(t,r,i,o,s,n,c,l,a){return new e.wmsInspectorService.WmsInspectorService(t,r,i,o,s,n,c,l,a)}]).controller("wmsInspectorCtrl",e.wmsInspectorService.WmsInspectorCtrl).directive("wmsInspectorPanel",function(){return{templateUrl:"rockprops/wms-inspector-panel.html",controller:r,controllerAs:"wmsInspectorVM"}})}(t=e.wmsInspectorService||(e.wmsInspectorService={}))}(rpComponents||(rpComponents={}));
//# sourceMappingURL=explorer-rock-properties-cesium-components.min.js.map
